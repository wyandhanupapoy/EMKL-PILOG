<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Input EMKL Trucking PT. Pasir Indah Logistik</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            page-break-after: avoid;
            /* Tambahkan ini */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .date-display {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input {
            width: auto;
            margin-right: 5px;
        }

        .party-container {
            margin-top: 10px;
            display: none;
        }

        .party-container.active {
            display: block;
        }

        .party-input {
            margin-bottom: 10px;
        }

        .party-input label {
            display: inline-block;
            width: 80px;
        }

        .party-input input {
            width: 80px;
            display: inline-block;
        }

        .staffing-container {
            margin-top: 10px;
        }

        .staffing-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .staffing-item label {
            display: inline-block;
            margin-bottom: 0;
            font-weight: normal;
        }

        .staffing-item input {
            flex: 1;
        }

        .staffing-item input[type="text"] {
            flex: 1;
            pointer-events: auto !important;
            user-select: auto !important;
            background-color: white !important;
            cursor: text !important;
        }

        .staffing-item input[type="text"]:focus {
            outline: 2px solid #2196F3;
            border-color: #2196F3;
        }

        .cost-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .cost-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cost-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .cost-total {
            margin-top: 10px;
            font-weight: bold;
            text-align: right;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 15px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        button:hover {
            background-color: #555;
        }

        .invoice-preview {
            display: none;
            margin-top: 30px;
            border: 2px solid #000;
            padding: 0;
            background-color: white;
            font-family: 'Courier New', 'Courier', monospace;
            font-size: 12px;
            line-height: 1.3;
            max-width: 21cm;
            margin-left: auto;
            margin-right: auto;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 3px double #000;
            padding: 15px 10px;
        }

        .invoice-header h2 {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            letter-spacing: 3px;
        }

        .invoice-header p {
            font-size: 10px;
            margin: 2px 0;
            line-height: 1.2;
        }

        .invoice-header h3 {
            font-size: 16px;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
            letter-spacing: 4px;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
            padding: 5px 0;
        }

        .invoice-header .invoice-number {
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 0 15px 15px 15px;
            font-size: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 10px;
        }

        .invoice-details p {
            margin: 3px 0;
            line-height: 1.4;
        }

        .invoice-table {
            width: calc(100% - 30px);
            margin: 0 15px 15px 15px;
            border-collapse: collapse;
            font-size: 10px;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: left;
            line-height: 1.3;
        }

        .invoice-table th {
            background-color: transparent;
            font-weight: bold;
            text-align: center;
            border: 2px solid #000;
        }

        .invoice-table tbody tr {
            border: 1px solid #000;
        }

        .terbilang-section {
            margin: 0 15px 15px 15px;
            padding: 10px;
            border: 2px solid #000;
            background-color: transparent;
            font-size: 10px;
            font-weight: bold;
        }

        .invoice-totals {
            margin: 0 15px 15px 15px;
            font-size: 11px;
            text-align: right;
            border-top: 2px solid #000;
            padding-top: 10px;
        }

        .invoice-totals p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .invoice-totals .grand-total {
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px double #000;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            margin: 30px 40px 20px 40px;
            page-break-inside: avoid;
        }

        .signature-box {
            text-align: center;
            font-size: 10px;
        }

        .signature-box>p {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .signature-line {
            margin-top: 60px;
            padding-top: 5px;
            border-top: 1px solid #000;
        }

        .signature-line p {
            margin: 3px 0;
            line-height: 1.3;
        }

        .invoice-footer {
            margin: 10px 15px 0 15px;
            /* Ubah margin-bottom jadi 0 */
            padding-top: 10px;
            padding-bottom: 0;
            /* Tambahkan ini */
            text-align: center;
            font-size: 9px;
            border-top: 1px solid #000;
        }

        @media print {
            @page {
                size: A4;
                margin: 0.5cm;
            }

            body * {
                visibility: hidden;
            }

            .invoice-preview,
            .invoice-preview * {
                visibility: visible;
            }

            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                padding: 0;
                margin: 0;
                background: white;
            }

            /* Optimasi untuk dot matrix */
            .invoice-preview {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color: #000 !important;
                background: white !important;
            }

            .invoice-table th {
                background-color: transparent !important;
                -webkit-print-color-adjust: exact;
            }

            .signature-section {
                page-break-inside: avoid;
            }

            .no-print {
                display: none !important;
                visibility: hidden !important;
            }

            /* Pastikan border tercetak dengan jelas */
            .invoice-table th,
            .invoice-table td,
            .terbilang-section {
                border-color: #000 !important;
            }
        }

        .history-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .history-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-section input {
            flex: 1;
            min-width: 200px;
        }

        .filter-section button {
            padding: 8px 15px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .history-table th,
        .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .history-table th {
            background-color: #333;
            color: white;
            font-weight: bold;
        }

        .history-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .history-table button {
            padding: 5px 10px;
            margin: 0 2px;
            font-size: 12px;
        }

        .history-table .btn-view {
            background-color: #4CAF50;
        }

        .history-table .btn-edit {
            background-color: #2196F3;
        }

        .history-table .btn-delete {
            background-color: #f44336;
        }

        .history-table .btn-view:hover {
            background-color: #45a049;
        }

        .history-table .btn-edit:hover {
            background-color: #0b7dda;
        }

        .history-table .btn-delete:hover {
            background-color: #da190b;
        }

        /* ========== RESPONSIVE DESIGN ========== */

        /* Tablet dan Mobile */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            header h1 {
                font-size: 18px;
            }

            .date-display {
                font-size: 12px;
            }

            /* Backup & Restore responsive */
            section .form-section>div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            #restoreFileInput {
                font-size: 12px;
            }

            h2 {
                font-size: 16px;
            }

            /* Party Checkbox - Stack vertically */
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .checkbox-item {
                width: 100%;
                justify-content: space-between;
                padding: 10px;
                background-color: #f9f9f9;
                border-radius: 4px;
                border: 1px solid #ddd;
            }

            .checkbox-item input[type="number"] {
                width: 80px !important;
                margin-left: 10px;
            }

            /* Form groups */
            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 14px;
            }

            /* Actions buttons */
            .actions {
                flex-direction: column;
            }

            .actions button {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Staffing items */
            .staffing-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .staffing-item label {
                width: 100%;
                margin-bottom: 5px;
            }

            .staffing-item input {
                width: 100% !important;
            }

            /* Cost items */
            .cost-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .cost-header input {
                width: 100%;
            }

            .cost-details {
                grid-template-columns: 1fr;
            }

            /* Filter section */
            .filter-section {
                flex-direction: column;
            }

            .filter-section input {
                width: 100%;
                min-width: auto;
            }

            .filter-section button {
                width: 100%;
            }

            /* History table - horizontal scroll */
            .history-section {
                overflow-x: auto;
            }

            .history-table {
                min-width: 800px;
                font-size: 12px;
            }

            .history-table th,
            .history-table td {
                padding: 8px 5px;
                font-size: 11px;
            }

            .history-table button {
                padding: 4px 8px;
                font-size: 11px;
                margin: 2px 0;
                display: block;
                width: 100%;
            }

            /* Invoice details */
            .invoice-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Invoice table */
            .invoice-table {
                font-size: 9px;
            }

            .invoice-table th,
            .invoice-table td {
                padding: 4px;
            }

            /* Signature section */
            .signature-section {
                grid-template-columns: 1fr;
                gap: 30px;
                margin: 20px 15px;
            }

            /* Invoice header */
            .invoice-header h2 {
                font-size: 16px;
            }

            .invoice-header h3 {
                font-size: 14px;
            }
        }

        /* Mobile Small */
        @media screen and (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 16px;
            }

            h2 {
                font-size: 14px;
            }

            .form-section {
                padding: 10px;
            }

            .checkbox-item {
                font-size: 13px;
            }

            .checkbox-item input[type="number"] {
                width: 60px !important;
            }

            button {
                padding: 8px 12px;
                font-size: 13px;
            }

            .history-table {
                font-size: 10px;
            }

            .invoice-preview {
                font-size: 10px;
            }

            .invoice-table {
                font-size: 8px;
            }

            .cost-item {
                padding: 8px;
            }
        }

        /* Landscape Mode */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .checkbox-group {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .checkbox-item {
                width: calc(50% - 5px);
            }

            .actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .actions button {
                width: calc(50% - 5px);
            }
        }

        /* Large Desktop */
        @media screen and (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }

            .invoice-details {
                gap: 30px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Data Input EMKL Trucking PT. Pasir Indah Logistik</h1>
            <div class="date-display" id="currentDate"></div>
        </header>

        <!-- Form Data Job Order -->
        <section class="form-section">
            <h2>Data Job Order</h2>
            <div class="form-group">
                <label for="jobOrderNo">No. Job Order:</label>
                <input type="text" id="jobOrderNo" value="PILOG001" readonly>
            </div>
            <div class="form-group">
                <label for="customerName">Nama Konsumen:</label>
                <select id="customerName">
                    <option value="">Pilih Konsumen</option>
                    <option value="PT. ABC Indonesia">PT. ABC Indonesia</option>
                    <option value="CV. Makmur Jaya">CV. Makmur Jaya</option>
                    <option value="UD. Sentosa">UD. Sentosa</option>
                </select>
                <button type="button" id="addCustomerBtn" style="margin-top: 5px; padding: 5px 10px;">Tambah Konsumen
                    Baru</button>
            </div>
            <div class="form-group">
                <label>Party:</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="party20" value="20ft">
                            <label for="party20" style="margin: 0 0 0 5px;">20ft</label>
                        </div>
                        <input type="number" id="qty20" min="0" value="0" placeholder="Qty">
                    </div>
                    <div class="checkbox-item">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="party40" value="40ft">
                            <label for="party40" style="margin: 0 0 0 5px;">40ft</label>
                        </div>
                        <input type="number" id="qty40" min="0" value="0" placeholder="Qty">
                    </div>
                    <div class="checkbox-item">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" id="party45" value="45ft">
                            <label for="party45" style="margin: 0 0 0 5px;">45ft</label>
                        </div>
                        <input type="number" id="qty45" min="0" value="0" placeholder="Qty">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="origin">Asal Keberangkatan:</label>
                <input type="text" id="origin">
            </div>
            <div class="form-group">
                <label for="destination">Tujuan:</label>
                <input type="text" id="destination">
            </div>
            <div class="form-group">
                <label for="shipName">Nama Kapal:</label>
                <input type="text" id="shipName">
            </div>
            <div class="form-group">
                <label for="etd">ETD:</label>
                <input type="date" id="etd">
            </div>
            <div class="form-group">
                <label for="notes">Keterangan:</label>
                <textarea id="notes" rows="3"></textarea>
            </div>
            <div class="actions">
                <button type="button" id="saveJobOrderBtn">Simpan Job Order</button>
                <button type="button" id="newJobOrderBtn">Job Order Baru</button>
                <button type="button" id="toggleJobOrderHistoryBtn">Tampilkan Riwayat Job Order</button>
            </div>
            <!-- Tabel Riwayat Job Order -->
            <div id="jobOrderHistory" class="history-section" style="display: none;">
                <h3>Riwayat Job Order</h3>
                <div class="filter-section">
                    <input type="text" id="filterJobOrder" placeholder="Cari berdasarkan No. Job Order, Konsumen...">
                    <input type="date" id="filterJobOrderDate">
                    <button type="button" id="clearFilterJobOrder">Clear Filter</button>
                </div>
                <table class="history-table" id="jobOrderTable">
                    <thead>
                        <tr>
                            <th>No. Job Order</th>
                            <th>Tanggal</th>
                            <th>Konsumen</th>
                            <th>Party</th>
                            <th>Asal - Tujuan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Form Data Staffing -->
        <!-- Form Data Staffing -->
        <section class="form-section">
            <h2>Data Staffing</h2>
            <div class="form-group">
                <label for="jobOrderSelect">Pilih Job Order:</label>
                <select id="jobOrderSelect">
                    <option value="">-- Pilih Job Order --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="staffingDate">Tanggal Staffing:</label>
                <input type="date" id="staffingDate">
            </div>
            <div id="staffingContainer" class="staffing-container">
                <p style="color: #999; font-style: italic;">Silakan pilih Job Order terlebih dahulu</p>
            </div>

            <div class="actions">
                <button type="button" id="saveStaffingBtn">Simpan Data Staffing</button>
                <button type="button" id="toggleStaffingHistoryBtn">Tampilkan Riwayat Staffing</button>
            </div>

            <!-- Tabel Riwayat Staffing -->
            <div id="staffingHistory" class="history-section" style="display: none;">
                <h3>Riwayat Data Staffing</h3>
                <div class="filter-section">
                    <input type="text" id="filterStaffing" placeholder="Cari berdasarkan Job Order, Container...">
                    <input type="date" id="filterStaffingDate">
                    <button type="button" id="clearFilterStaffing">Clear Filter</button>
                </div>
                <table class="history-table" id="staffingTable">
                    <thead>
                        <tr>
                            <th>Job Order</th>
                            <th>Tanggal Staffing</th>
                            <th>Konsumen</th>
                            <th>Jumlah Container</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Form Data Biaya -->
        <section class="form-section">
            <h2>Data Biaya</h2>
            <div class="form-group">
                <label for="jobOrderSelectCost">Pilih Job Order:</label>
                <select id="jobOrderSelectCost">
                    <option value="">-- Pilih Job Order --</option>
                </select>
            </div>
            <div id="costItems">
                <!-- Cost items will be generated here -->
            </div>
            <button type="button" id="addCostItemBtn">Tambah Item Biaya</button>
            <div class="cost-total" id="costTotal">Total: Rp 0</div>
            <div class="actions">
                <button type="button" id="saveCostBtn">Simpan Data Biaya</button>
                <button type="button" id="toggleCostHistoryBtn">Tampilkan Riwayat Biaya</button>
            </div>

            <!-- Tabel Riwayat Biaya -->
            <div id="costHistory" class="history-section" style="display: none;">
                <h3>Riwayat Data Biaya</h3>
                <div class="filter-section">
                    <input type="text" id="filterCost" placeholder="Cari berdasarkan Job Order...">
                    <input type="date" id="filterCostDate">
                    <button type="button" id="clearFilterCost">Clear Filter</button>
                </div>
                <table class="history-table" id="costTable">
                    <thead>
                        <tr>
                            <th>Job Order</th>
                            <th>Konsumen</th>
                            <th>Total Item</th>
                            <th>Total Biaya</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Button untuk Generate Invoice & Report -->
        <!-- Button untuk Generate Invoice & Report -->
        <section class="form-section">
            <h2>Generate Invoice & Laporan</h2>

            <!-- Bagian Invoice -->
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">📄 Generate Invoice</h3>
                <div
                    style="background: #fff3cd; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #ffc107;">
                    <strong>⚠️ Tips Print Dot Matrix:</strong>
                    <ul style="margin: 5px 0 0 20px; font-size: 12px;">
                        <li>Pastikan printer dot matrix sudah terinstall</li>
                        <li>Gunakan kertas continuous form atau A4</li>
                        <li>Set printer ke mode "Draft" atau "Text" untuk hasil terbaik</li>
                        <li>Pastikan ribbon masih bagus untuk hasil yang jelas</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label for="jobOrderSelectInvoice">Pilih Job Order untuk Invoice:</label>
                    <select id="jobOrderSelectInvoice">
                        <option value="">-- Pilih Job Order --</option>
                    </select>
                </div>
                <div class="actions">
                    <button type="button" id="generateInvoiceBtn">Generate Invoice</button>
                    <button type="button" id="printInvoiceBtn" class="no-print">Cetak Invoice</button>
                </div>
            </div>

            <!-- Bagian Export Laporan -->
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; background-color: #f0f8ff;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">📊 Export Laporan</h3>
                <p style="margin-bottom: 15px; color: #666;">Export semua data Job Order, Staffing, dan Biaya ke dalam
                    file Excel</p>
                <div class="actions">
                    <button type="button" id="exportExcelBtn" style="background-color: #28a745;">
                        📥 Export Semua Data ke Excel
                    </button>
                </div>
            </div>
        </section>

        <!-- Backup & Restore Data -->
        <section class="form-section">
            <h2>🔒 Backup & Restore Data</h2>
            <div
                style="background: #e8f5e9; padding: 15px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #4caf50;">
                <strong>ℹ️ Informasi:</strong>
                <ul style="margin: 5px 0 0 20px; font-size: 12px;">
                    <li>Backup akan menyimpan semua data Job Order, Staffing, Biaya, dan Konsumen</li>
                    <li>File backup berformat JSON yang aman</li>
                    <li>Gunakan Restore untuk memindahkan data ke laptop/komputer lain</li>
                    <li>Restore akan <strong>menimpa</strong> semua data yang ada saat ini</li>
                </ul>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- Backup -->
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">💾 Backup Data</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 13px;">
                        Download semua data dalam 1 file backup
                    </p>
                    <button type="button" id="backupDataBtn" style="width: 100%; background-color: #4caf50;">
                        📥 Download Backup
                    </button>
                    <p id="backupInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></p>
                </div>

                <!-- Restore -->
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 4px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">📤 Restore Data</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 13px;">
                        Upload file backup untuk restore data
                    </p>
                    <input type="file" id="restoreFileInput" accept=".json" style="margin-bottom: 10px; padding: 5px;">
                    <button type="button" id="restoreDataBtn" style="width: 100%; background-color: #ff9800;">
                        📤 Restore Data
                    </button>
                </div>
            </div>

            <!-- Clear All Data -->
            <div
                style="margin-top: 15px; padding: 15px; background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px;">
                <h3 style="font-size: 16px; margin-bottom: 10px; color: #d32f2f;">⚠️ Danger Zone</h3>
                <p style="margin-bottom: 10px; font-size: 13px;">Hapus semua data permanen (tidak bisa dikembalikan)</p>
                <button type="button" id="clearAllDataBtn" style="background-color: #f44336;">
                    🗑️ Hapus Semua Data
                </button>
            </div>
        </section>


        <!-- Invoice Preview -->
        <div id="invoicePreview" class="invoice-preview">
            <div class="invoice-header">
                <h2>PT. PASIR INDAH LOGISTIK</h2>
                <p>Jl. Gedebage Selatan No.65, Cisaranten Kidul, Kec. Gedebage, Kota Bandung, Jawa Barat 40295</p>
                <h3>INVOICE</h3>
                <p class="invoice-number">No. Invoice: <span id="invInvoiceNo"></span></p>
            </div>

            <div class="invoice-details">
                <div>
                    <p><strong>No. Job Order</strong> : <span id="invJobOrderNo"></span></p>
                    <p><strong>Tanggal</strong> : <span id="invDate"></span></p>
                    <p><strong>Konsumen</strong> : <span id="invCustomer"></span></p>
                </div>
                <div>
                    <p><strong>Asal</strong> : <span id="invOrigin"></span></p>
                    <p><strong>Tujuan</strong> : <span id="invDestination"></span></p>
                    <p><strong>Kapal</strong> : <span id="invShip"></span></p>
                    <p><strong>ETD</strong> : <span id="invETD"></span></p>
                </div>
            </div>

            <table class="invoice-table" id="invoiceTable">
                <thead>
                    <tr>
                        <th style="width: 5%;">NO</th>
                        <th style="width: 30%;">URAIAN</th>
                        <th style="width: 20%;">KETERANGAN</th>
                        <th style="width: 15%;">DPP</th>
                        <th style="width: 15%;">PPN 11%</th>
                        <th style="width: 15%;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Invoice items will be generated here -->
                </tbody>
            </table>

            <div class="terbilang-section">
                <p>TERBILANG: <span id="invTerbilang" style="text-transform: uppercase;"></span></p>
            </div>

            <div class="invoice-totals">
                <p>SUBTOTAL : <span id="invSubtotal">Rp 0</span></p>
                <p>PPN 11% : <span id="invPPN">Rp 0</span></p>
                <p class="grand-total">GRAND TOTAL : <span id="invTotal">Rp 0</span></p>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <p>Hormat Kami,</p>
                    <div class="signature-line">
                        <p>( _________________ )</p>
                        <p><strong>PT. Pasir Indah Logistik</strong></p>
                    </div>
                </div>
                <div class="signature-box">
                    <!-- Kolom kosong atau bisa dihapus -->
                </div>
            </div>

            <div class="invoice-footer">
                <p>*** TERIMA KASIH ATAS KEPERCAYAAN ANDA ***</p>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk mengkonversi angka ke terbilang
        function terbilang(angka) {
            const bilangan = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];

            if (angka < 12) {
                return bilangan[angka];
            } else if (angka < 20) {
                return bilangan[angka - 10] + ' Belas';
            } else if (angka < 100) {
                return bilangan[Math.floor(angka / 10)] + ' Puluh ' + bilangan[angka % 10];
            } else if (angka < 200) {
                return 'Seratus ' + terbilang(angka - 100);
            } else if (angka < 1000) {
                return bilangan[Math.floor(angka / 100)] + ' Ratus ' + terbilang(angka % 100);
            } else if (angka < 2000) {
                return 'Seribu ' + terbilang(angka - 1000);
            } else if (angka < 1000000) {
                return terbilang(Math.floor(angka / 1000)) + ' Ribu ' + terbilang(angka % 1000);
            } else if (angka < 1000000000) {
                return terbilang(Math.floor(angka / 1000000)) + ' Juta ' + terbilang(angka % 1000000);
            } else if (angka < 1000000000000) {
                return terbilang(Math.floor(angka / 1000000000)) + ' Miliar ' + terbilang(angka % 1000000000);
            } else if (angka < 1000000000000000) {
                return terbilang(Math.floor(angka / 1000000000000)) + ' Triliun ' + terbilang(angka % 1000000000000);
            } else {
                return 'Angka terlalu besar';
            }
        }

        function angkaTerbilang(angka) {
            if (angka === 0) return 'Nol Rupiah';

            const terbilangText = terbilang(angka).trim().replace(/\s+/g, ' ');
            return terbilangText + ' Rupiah';
        }

        // Initialize current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Update date on page load
        updateCurrentDate();

        // Job Order Management
        let allJobOrders = JSON.parse(localStorage.getItem('allJobOrders')) || [];
        // Storage untuk setiap form
        let allStaffingData = JSON.parse(localStorage.getItem('allStaffingData')) || [];
        let allCostData = JSON.parse(localStorage.getItem('allCostData')) || [];
        let currentJobOrderId = null;

        function generateJobOrderNo() {
            const lastNo = allJobOrders.length > 0 ?
                Math.max(...allJobOrders.map(jo => parseInt(jo.jobOrderNo.replace('PILOG', '')))) : 0;
            return 'PILOG' + String(lastNo + 1).padStart(3, '0');
        }

        function loadJobOrdersList() {
            const selects = [
                document.getElementById('jobOrderSelect'),
                document.getElementById('jobOrderSelectCost'),
                document.getElementById('jobOrderSelectInvoice')  // TAMBAHKAN INI
            ];

            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">-- Pilih Job Order --</option>';
                    allJobOrders.forEach(jo => {
                        const option = document.createElement('option');
                        option.value = jo.id;
                        option.textContent = `${jo.jobOrderNo} - ${jo.customerName}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Initialize data from localStorage
        function initializeData() {
            // Load customers
            const customers = JSON.parse(localStorage.getItem('customers')) || [
                'PT. ABC Indonesia', 'CV. Makmur Jaya', 'UD. Sentosa'
            ];

            const customerSelect = document.getElementById('customerName');
            customerSelect.innerHTML = '<option value="">Pilih Konsumen</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerSelect.appendChild(option);
            });

            // Setup party checkbox listeners
            document.querySelectorAll('input[type="checkbox"][id^="party"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const qtyInput = document.getElementById('qty' + this.value.replace('ft', ''));
                    if (this.checked) {
                        qtyInput.disabled = false;
                        if (qtyInput.value === '0') qtyInput.value = '1';
                    } else {
                        qtyInput.disabled = true;
                        qtyInput.value = '0';
                    }
                });
            });

            // Initialize qty inputs as disabled
            document.querySelectorAll('input[type="number"][id^="qty"]').forEach(input => {
                input.disabled = true;
            });
        }

        // Add new customer
        document.getElementById('addCustomerBtn').addEventListener('click', function () {
            const customerName = prompt('Masukkan nama konsumen baru:');
            if (customerName) {
                // Add to select
                const customerSelect = document.getElementById('customerName');
                const option = document.createElement('option');
                option.value = customerName;
                option.textContent = customerName;
                customerSelect.appendChild(option);
                customerSelect.value = customerName;

                // Save to localStorage
                const customers = JSON.parse(localStorage.getItem('customers')) || [];
                if (!customers.includes(customerName)) {
                    customers.push(customerName);
                    localStorage.setItem('customers', JSON.stringify(customers));
                }
            }
        });

        document.getElementById('newJobOrderBtn').addEventListener('click', function () {
            if (confirm('Buat Job Order baru? Data yang belum disimpan akan hilang.')) {
                currentJobOrderId = null;
                document.getElementById('jobOrderNo').value = generateJobOrderNo();
                document.getElementById('customerName').value = '';
                document.getElementById('origin').value = '';
                document.getElementById('destination').value = '';
                document.getElementById('shipName').value = '';
                document.getElementById('etd').value = '';
                document.getElementById('notes').value = '';

                // Uncheck all party and reset quantities
                document.querySelectorAll('input[type="checkbox"][id^="party"]').forEach(cb => {
                    cb.checked = false;
                });

                document.querySelectorAll('input[type="number"][id^="qty"]').forEach(input => {
                    input.value = '0';
                    input.disabled = true;
                });
            }
        });

        document.getElementById('saveJobOrderBtn').addEventListener('click', function () {
            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Nama konsumen harus diisi!');
                return;
            }

            const jobOrderData = {
                id: currentJobOrderId || Date.now().toString(),
                jobOrderNo: document.getElementById('jobOrderNo').value,
                customerName: customerName,
                party: [],
                origin: document.getElementById('origin').value,
                destination: document.getElementById('destination').value,
                shipName: document.getElementById('shipName').value,
                etd: document.getElementById('etd').value,
                notes: document.getElementById('notes').value,
                createdDate: new Date().toISOString()
            };

            document.querySelectorAll('input[type="checkbox"][id^="party"]:checked').forEach(checkbox => {
                const party = checkbox.value;
                const qty = parseInt(document.getElementById('qty' + party.replace('ft', '')).value) || 0;
                if (qty > 0) {
                    jobOrderData.party.push({ size: party, quantity: qty });
                }
            });

            if (jobOrderData.party.length === 0) {
                alert('Minimal pilih 1 party dan isi quantity!');
                return;
            }

            const existingIndex = allJobOrders.findIndex(jo => jo.id === jobOrderData.id);
            if (existingIndex >= 0) {
                allJobOrders[existingIndex] = jobOrderData;
                alert('Job Order berhasil diupdate!');
            } else {
                allJobOrders.push(jobOrderData);
                currentJobOrderId = jobOrderData.id;
                alert('Job Order berhasil disimpan!');
            }

            localStorage.setItem('allJobOrders', JSON.stringify(allJobOrders));
            loadJobOrdersList();
            renderJobOrderHistory();

            // Auto generate nomor baru untuk job order berikutnya
            if (confirm('Job Order berhasil disimpan! Buat Job Order baru?')) {
                currentJobOrderId = null;
                document.getElementById('jobOrderNo').value = generateJobOrderNo();
                document.getElementById('customerName').value = '';
                document.getElementById('origin').value = '';
                document.getElementById('destination').value = '';
                document.getElementById('shipName').value = '';
                document.getElementById('etd').value = '';
                document.getElementById('notes').value = '';

                document.querySelectorAll('input[type="checkbox"][id^="party"]').forEach(cb => {
                    cb.checked = false;
                });

                document.querySelectorAll('input[type="number"][id^="qty"]').forEach(input => {
                    input.value = '0';
                    input.disabled = true;
                });
            }
        });

        document.getElementById('toggleJobOrderHistoryBtn').addEventListener('click', function () {
            const historySection = document.getElementById('jobOrderHistory');
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                this.textContent = 'Sembunyikan Riwayat';
                renderJobOrderHistory();
            } else {
                historySection.style.display = 'none';
                this.textContent = 'Tampilkan Riwayat Job Order';
            }
        });

        function renderJobOrderHistory(filterText = '', filterDate = '') {
            const tbody = document.querySelector('#jobOrderTable tbody');
            tbody.innerHTML = '';

            let filteredData = allJobOrders.filter(jo => {
                const matchText = !filterText ||
                    jo.jobOrderNo.toLowerCase().includes(filterText.toLowerCase()) ||
                    jo.customerName.toLowerCase().includes(filterText.toLowerCase()) ||
                    jo.origin.toLowerCase().includes(filterText.toLowerCase()) ||
                    jo.destination.toLowerCase().includes(filterText.toLowerCase());

                const matchDate = !filterDate ||
                    new Date(jo.createdDate).toISOString().split('T')[0] === filterDate;

                return matchText && matchDate;
            });

            filteredData.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

            filteredData.forEach(jo => {
                const row = document.createElement('tr');
                const partyText = jo.party.map(p => `${p.size}(${p.quantity})`).join(', ');
                const dateText = new Date(jo.createdDate).toLocaleDateString('id-ID');

                row.innerHTML = `
            <td>${jo.jobOrderNo}</td>
            <td>${dateText}</td>
            <td>${jo.customerName}</td>
            <td>${partyText}</td>
            <td>${jo.origin} - ${jo.destination}</td>
            <td>
                <button class="btn-view" onclick="viewJobOrder('${jo.id}')">Lihat</button>
                <button class="btn-edit" onclick="editJobOrder('${jo.id}')">Edit</button>
                <button class="btn-delete" onclick="deleteJobOrder('${jo.id}')">Hapus</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

        // Filter Job Order
        document.getElementById('filterJobOrder').addEventListener('input', function () {
            const filterDate = document.getElementById('filterJobOrderDate').value;
            renderJobOrderHistory(this.value, filterDate);
        });

        document.getElementById('filterJobOrderDate').addEventListener('change', function () {
            const filterText = document.getElementById('filterJobOrder').value;
            renderJobOrderHistory(filterText, this.value);
        });

        document.getElementById('clearFilterJobOrder').addEventListener('click', function () {
            document.getElementById('filterJobOrder').value = '';
            document.getElementById('filterJobOrderDate').value = '';
            renderJobOrderHistory();
        });

        function viewJobOrder(id) {
            const jo = allJobOrders.find(j => j.id === id);
            if (!jo) return;

            let partyDetails = jo.party.map(p => `${p.size}: ${p.quantity} unit`).join('\n');

            alert(`Detail Job Order\n\n` +
                `No: ${jo.jobOrderNo}\n` +
                `Konsumen: ${jo.customerName}\n` +
                `Party:\n${partyDetails}\n` +
                `Asal: ${jo.origin}\n` +
                `Tujuan: ${jo.destination}\n` +
                `Kapal: ${jo.shipName}\n` +
                `ETD: ${jo.etd}\n` +
                `Keterangan: ${jo.notes}`);
        }

        function editJobOrder(id) {
            const jo = allJobOrders.find(j => j.id === id);
            if (!jo) return;

            currentJobOrderId = jo.id;
            document.getElementById('jobOrderNo').value = jo.jobOrderNo;
            document.getElementById('customerName').value = jo.customerName;
            document.getElementById('origin').value = jo.origin;
            document.getElementById('destination').value = jo.destination;
            document.getElementById('shipName').value = jo.shipName;
            document.getElementById('etd').value = jo.etd;
            document.getElementById('notes').value = jo.notes;

            // Reset party
            document.querySelectorAll('input[type="checkbox"][id^="party"]').forEach(cb => {
                cb.checked = false;
                const qtyInput = document.getElementById('qty' + cb.value.replace('ft', ''));
                qtyInput.value = '0';
                qtyInput.disabled = true;
            });

            // Set party
            jo.party.forEach(p => {
                const checkbox = document.getElementById('party' + p.size.replace('ft', ''));
                const qtyInput = document.getElementById('qty' + p.size.replace('ft', ''));
                if (checkbox && qtyInput) {
                    checkbox.checked = true;
                    qtyInput.disabled = false;
                    qtyInput.value = p.quantity;
                }
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
            alert('Data Job Order dimuat. Silakan edit dan simpan kembali.');
        }

        function deleteJobOrder(id) {
            if (confirm('Yakin ingin menghapus Job Order ini?')) {
                allJobOrders = allJobOrders.filter(j => j.id !== id);
                localStorage.setItem('allJobOrders', JSON.stringify(allJobOrders));
                loadJobOrdersList();
                renderJobOrderHistory();
                alert('Job Order berhasil dihapus!');
            }
        }

        document.getElementById('saveStaffingBtn').addEventListener('click', function () {
            const jobOrderId = document.getElementById('jobOrderSelect').value;
            if (!jobOrderId) {
                alert('Pilih Job Order terlebih dahulu!');
                return;
            }

            const staffingDate = document.getElementById('staffingDate').value;
            if (!staffingDate) {
                alert('Tanggal staffing harus diisi!');
                return;
            }

            // Collect all containers
            const containers = [];
            let hasEmptyContainer = false;

            document.querySelectorAll('.staffing-item input[type="text"]').forEach(input => {
                if (input.value.trim()) {
                    containers.push({
                        party: input.dataset.party,
                        number: input.value.trim()
                    });
                } else {
                    hasEmptyContainer = true;
                }
            });

            if (hasEmptyContainer && !confirm('Ada nomor container yang kosong. Lanjutkan menyimpan?')) {
                return;
            }

            if (containers.length === 0) {
                alert('Minimal harus ada 1 nomor container yang diisi!');
                return;
            }

            const jobOrder = allJobOrders.find(jo => jo.id === jobOrderId);

            const staffingData = {
                id: Date.now().toString(),
                jobOrderId: jobOrderId,
                jobOrderNo: jobOrder.jobOrderNo,
                customerName: jobOrder.customerName,
                date: staffingDate,
                containers: containers,
                createdDate: new Date().toISOString()
            };

            allStaffingData.push(staffingData);
            localStorage.setItem('allStaffingData', JSON.stringify(allStaffingData));
            renderStaffingHistory();

            // Clear form after save
            document.querySelectorAll('.staffing-item input[type="text"]').forEach(input => {
                input.value = '';
            });

            alert(`Data Staffing berhasil disimpan!\nTotal: ${containers.length} container`);
        });

        document.getElementById('toggleStaffingHistoryBtn').addEventListener('click', function () {
            const historySection = document.getElementById('staffingHistory');
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                this.textContent = 'Sembunyikan Riwayat';
                renderStaffingHistory();
            } else {
                historySection.style.display = 'none';
                this.textContent = 'Tampilkan Riwayat Staffing';
            }
        });

        function renderStaffingHistory(filterText = '', filterDate = '') {
            const tbody = document.querySelector('#staffingTable tbody');
            tbody.innerHTML = '';

            let filteredData = allStaffingData.filter(sd => {
                const jo = allJobOrders.find(j => j.id === sd.jobOrderId);
                const matchText = !filterText ||
                    (jo && (jo.jobOrderNo.toLowerCase().includes(filterText.toLowerCase()) ||
                        jo.customerName.toLowerCase().includes(filterText.toLowerCase()))) ||
                    sd.containers.some(c => c.number.toLowerCase().includes(filterText.toLowerCase()));

                const matchDate = !filterDate || sd.date === filterDate;

                return matchText && matchDate;
            });

            filteredData.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

            filteredData.forEach(sd => {
                const jo = allJobOrders.find(j => j.id === sd.jobOrderId);
                if (!jo) return;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${jo.jobOrderNo}</td>
            <td>${new Date(sd.date).toLocaleDateString('id-ID')}</td>
            <td>${jo.customerName}</td>
            <td>${sd.containers.length} container</td>
            <td>
                <button class="btn-view" onclick="viewStaffing('${sd.id}')">Lihat</button>
                <button class="btn-delete" onclick="deleteStaffing('${sd.id}')">Hapus</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

        document.getElementById('filterStaffing').addEventListener('input', function () {
            const filterDate = document.getElementById('filterStaffingDate').value;
            renderStaffingHistory(this.value, filterDate);
        });

        document.getElementById('filterStaffingDate').addEventListener('change', function () {
            const filterText = document.getElementById('filterStaffing').value;
            renderStaffingHistory(filterText, this.value);
        });

        document.getElementById('clearFilterStaffing').addEventListener('click', function () {
            document.getElementById('filterStaffing').value = '';
            document.getElementById('filterStaffingDate').value = '';
            renderStaffingHistory();
        });

        function viewStaffing(id) {
            const sd = allStaffingData.find(s => s.id === id);
            if (!sd) return;

            const jo = allJobOrders.find(j => j.id === sd.jobOrderId);

            // Group containers by party
            const groupedContainers = {};
            sd.containers.forEach(c => {
                if (!groupedContainers[c.party]) {
                    groupedContainers[c.party] = [];
                }
                groupedContainers[c.party].push(c.number);
            });

            let containerDetails = '';
            Object.keys(groupedContainers).forEach(party => {
                containerDetails += `\n${party} (${groupedContainers[party].length} unit):\n`;
                groupedContainers[party].forEach((num, idx) => {
                    containerDetails += `  ${idx + 1}. ${num}\n`;
                });
            });

            // Create a better formatted alert
            const message =
                `╔════════════════════════════════════╗\n` +
                `║      DETAIL DATA STAFFING         ║\n` +
                `╚════════════════════════════════════╝\n\n` +
                `Job Order    : ${jo ? jo.jobOrderNo : 'N/A'}\n` +
                `Konsumen     : ${jo ? jo.customerName : 'N/A'}\n` +
                `Tgl Staffing : ${new Date(sd.date).toLocaleDateString('id-ID')}\n` +
                `Total        : ${sd.containers.length} container\n` +
                `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n` +
                `DAFTAR CONTAINER:${containerDetails}`;

            alert(message);
        }

        function deleteStaffing(id) {
            if (confirm('Yakin ingin menghapus data staffing ini?')) {
                allStaffingData = allStaffingData.filter(s => s.id !== id);
                localStorage.setItem('allStaffingData', JSON.stringify(allStaffingData));
                renderStaffingHistory();
                alert('Data Staffing berhasil dihapus!');
            }
        }

        // Add cost item
        document.getElementById('addCostItemBtn').addEventListener('click', addCostItem);

        function addCostItem() {
            const costItems = document.getElementById('costItems');
            const itemCount = costItems.querySelectorAll('.cost-item').length;

            const costItem = document.createElement('div');
            costItem.className = 'cost-item';
            costItem.innerHTML = `
                <div class="cost-header">
                    <input type="text" class="item-name" placeholder="Nama Item" value="EMKL">
                    <button type="button" class="remove-item-btn">Hapus</button>
                </div>
                <div class="cost-details">
                    <div>
                        <label>Harga:</label>
                        <input type="number" class="item-price" value="100000" min="0">
                    </div>
                    <div>
                        <label>Jumlah:</label>
                        <input type="number" class="item-quantity" value="1" min="1">
                    </div>
                    <div>
                        <label>PPN 11%:</label>
                        <input type="checkbox" class="item-ppn" checked>
                    </div>
                    <div>
                        <label>DPP:</label>
                        <input type="text" class="item-dpp" readonly>
                    </div>
                    <div>
                        <label>PPN:</label>
                        <input type="text" class="item-ppn-amount" readonly>
                    </div>
                    <div>
                        <label>Total:</label>
                        <input type="text" class="item-total" readonly>
                    </div>
                </div>
            `;

            costItems.appendChild(costItem);

            // Add event listeners
            costItem.querySelector('.remove-item-btn').addEventListener('click', function () {
                costItem.remove();
                calculateTotalCost();
            });

            costItem.querySelectorAll('.item-price, .item-quantity, .item-ppn').forEach(input => {
                input.addEventListener('input', function () {
                    calculateItemCost(costItem);
                });
            });

            // Calculate initial cost
            calculateItemCost(costItem);
        }

        // Calculate cost for a single item
        function calculateItemCost(costItem) {
            const price = parseFloat(costItem.querySelector('.item-price').value) || 0;
            const quantity = parseInt(costItem.querySelector('.item-quantity').value) || 0;
            const applyPPN = costItem.querySelector('.item-ppn').checked;

            const subtotal = price * quantity;
            const dpp = applyPPN ? subtotal * 11 / 12 : subtotal;
            const ppn = applyPPN ? subtotal * 1 / 12 : 0;
            const total = subtotal;

            // Format to Indonesian Rupiah
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });

            costItem.querySelector('.item-dpp').value = formatter.format(dpp);
            costItem.querySelector('.item-ppn-amount').value = formatter.format(ppn);
            costItem.querySelector('.item-total').value = formatter.format(total);

            calculateTotalCost();
        }

        // Calculate total cost
        function calculateTotalCost() {
            let subtotal = 0;
            let totalPPN = 0;
            let total = 0;

            document.querySelectorAll('.cost-item').forEach(costItem => {
                const price = parseFloat(costItem.querySelector('.item-price').value) || 0;
                const quantity = parseInt(costItem.querySelector('.item-quantity').value) || 0;
                const applyPPN = costItem.querySelector('.item-ppn').checked;

                const itemSubtotal = price * quantity;
                subtotal += itemSubtotal;

                if (applyPPN) {
                    totalPPN += itemSubtotal * 1 / 12;
                }

                total += itemSubtotal;
            });

            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });

            document.getElementById('costTotal').textContent = `Total: ${formatter.format(total)}`;
        }

        // Save data to localStorage

        // Pastikan event listener ini ADA dan TIDAK DUPLIKAT
        document.getElementById('jobOrderSelect').addEventListener('change', function () {
            const jobOrderId = this.value;
            const staffingContainer = document.getElementById('staffingContainer');

            if (!jobOrderId) {
                staffingContainer.innerHTML = '<p style="color: #999; font-style: italic;">Silakan pilih Job Order terlebih dahulu</p>';
                return;
            }

            const jobOrder = allJobOrders.find(jo => jo.id === jobOrderId);
            if (!jobOrder) {
                staffingContainer.innerHTML = '<p style="color: #f44336;">Job Order tidak ditemukan</p>';
                return;
            }

            if (!jobOrder.party || jobOrder.party.length === 0) {
                staffingContainer.innerHTML = '<p style="color: #f44336;">Job Order ini tidak memiliki data party</p>';
                return;
            }

            // Clear container
            staffingContainer.innerHTML = '';

            // Show job order info
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'background: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #2196F3;';
            infoDiv.innerHTML = `
        <strong>📋 Job Order:</strong> ${jobOrder.jobOrderNo}<br>
        <strong>👤 Konsumen:</strong> ${jobOrder.customerName}<br>
        <strong>📦 Party:</strong> ${jobOrder.party.map(p => `${p.size} (${p.quantity} unit)`).join(', ')}
    `;
            staffingContainer.appendChild(infoDiv);

            // Generate container inputs based on party quantities
            let containerIndex = 1;
            jobOrder.party.forEach(partyItem => {
                for (let i = 0; i < partyItem.quantity; i++) {
                    const staffingItem = document.createElement('div');
                    staffingItem.className = 'staffing-item';
                    staffingItem.innerHTML = `
                <label style="min-width: 150px;">${partyItem.size} - Container ${containerIndex}:</label>
                <input type="text" 
                       data-party="${partyItem.size}" 
                       data-index="${containerIndex}"
                       maxlength="20" 
                       placeholder="Nomor Container"
                       style="flex: 1;">
            `;
                    staffingContainer.appendChild(staffingItem);
                    containerIndex++;
                }
            });

            console.log('Container inputs generated:', containerIndex - 1); // Debug
        });

        document.getElementById('saveCostBtn').addEventListener('click', function () {
            const jobOrderId = document.getElementById('jobOrderSelectCost').value;
            if (!jobOrderId) {
                alert('Pilih Job Order terlebih dahulu!');
                return;
            }

            const costItems = document.querySelectorAll('.cost-item');
            if (costItems.length === 0) {
                alert('Belum ada item biaya yang ditambahkan!');
                return;
            }

            const items = [];
            costItems.forEach(costItem => {
                items.push({
                    name: costItem.querySelector('.item-name').value,
                    price: parseFloat(costItem.querySelector('.item-price').value) || 0,
                    quantity: parseInt(costItem.querySelector('.item-quantity').value) || 0,
                    ppn: costItem.querySelector('.item-ppn').checked
                });
            });

            const jobOrder = allJobOrders.find(jo => jo.id === jobOrderId);

            const costData = {
                id: Date.now().toString(),
                jobOrderId: jobOrderId,
                jobOrderNo: jobOrder.jobOrderNo,
                customerName: jobOrder.customerName,
                items: items,
                createdDate: new Date().toISOString()
            };

            // Check if cost data already exists for this job order
            const existingIndex = allCostData.findIndex(cd => cd.jobOrderId === jobOrderId);
            if (existingIndex >= 0) {
                if (confirm('Data biaya untuk Job Order ini sudah ada. Timpa data yang lama?')) {
                    allCostData[existingIndex] = costData;
                } else {
                    return;
                }
            } else {
                allCostData.push(costData);
            }

            localStorage.setItem('allCostData', JSON.stringify(allCostData));
            renderCostHistory();
            alert('Data Biaya berhasil disimpan!');
        });

        document.getElementById('toggleCostHistoryBtn').addEventListener('click', function () {
            const historySection = document.getElementById('costHistory');
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                this.textContent = 'Sembunyikan Riwayat';
                renderCostHistory();
            } else {
                historySection.style.display = 'none';
                this.textContent = 'Tampilkan Riwayat Biaya';
            }
        });

        function renderCostHistory(filterText = '', filterDate = '') {
            const tbody = document.querySelector('#costTable tbody');
            tbody.innerHTML = '';

            let filteredData = allCostData.filter(cd => {
                const jo = allJobOrders.find(j => j.id === cd.jobOrderId);
                const matchText = !filterText ||
                    (jo && (jo.jobOrderNo.toLowerCase().includes(filterText.toLowerCase()) ||
                        jo.customerName.toLowerCase().includes(filterText.toLowerCase())));

                const matchDate = !filterDate ||
                    new Date(cd.createdDate).toISOString().split('T')[0] === filterDate;

                return matchText && matchDate;
            });

            filteredData.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

            filteredData.forEach(cd => {
                const jo = allJobOrders.find(j => j.id === cd.jobOrderId);
                if (!jo) return;

                // Calculate total
                let total = 0;
                cd.items.forEach(item => {
                    total += item.price * item.quantity;
                });

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${jo.jobOrderNo}</td>
            <td>${jo.customerName}</td>
            <td>${cd.items.length} item</td>
            <td>${formatCurrency(total)}</td>
            <td>
                <button class="btn-view" onclick="viewCost('${cd.id}')">Lihat</button>
                <button class="btn-delete" onclick="deleteCost('${cd.id}')">Hapus</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

        document.getElementById('filterCost').addEventListener('input', function () {
            const filterDate = document.getElementById('filterCostDate').value;
            renderCostHistory(this.value, filterDate);
        });

        document.getElementById('filterCostDate').addEventListener('change', function () {
            const filterText = document.getElementById('filterCost').value;
            renderCostHistory(filterText, this.value);
        });

        document.getElementById('clearFilterCost').addEventListener('click', function () {
            document.getElementById('filterCost').value = '';
            document.getElementById('filterCostDate').value = '';
            renderCostHistory();
        });

        function viewCost(id) {
            const cd = allCostData.find(c => c.id === id);
            if (!cd) return;

            const jo = allJobOrders.find(j => j.id === cd.jobOrderId);

            let itemDetails = '';
            let total = 0;
            cd.items.forEach((item, idx) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                itemDetails += `\n${idx + 1}. ${item.name}\n`;
                itemDetails += `   ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(itemTotal)}\n`;
                itemDetails += `   PPN: ${item.ppn ? 'Ya' : 'Tidak'}\n`;
            });

            alert(`Detail Biaya\n\n` +
                `Job Order: ${jo ? jo.jobOrderNo : 'N/A'}\n` +
                `Konsumen: ${jo ? jo.customerName : 'N/A'}\n` +
                `Total Item: ${cd.items.length}\n` +
                `\nRincian:${itemDetails}\n` +
                `Total: ${formatCurrency(total)}`);
        }

        function deleteCost(id) {
            if (confirm('Yakin ingin menghapus data biaya ini?')) {
                allCostData = allCostData.filter(c => c.id !== id);
                localStorage.setItem('allCostData', JSON.stringify(allCostData));
                renderCostHistory();
                alert('Data Biaya berhasil dihapus!');
            }
        }

        document.getElementById('generateInvoiceBtn').addEventListener('click', function () {
            const jobOrderId = document.getElementById('jobOrderSelectInvoice').value;
            if (!jobOrderId) {
                alert('Pilih Job Order terlebih dahulu!');
                return;
            }

            // Get job order data
            const jobOrder = allJobOrders.find(jo => jo.id === jobOrderId);
            if (!jobOrder) {
                alert('Job Order tidak ditemukan!');
                return;
            }

            // Get cost data for this job order
            const costData = allCostData.find(cd => cd.jobOrderId === jobOrderId);
            if (!costData || !costData.items || costData.items.length === 0) {
                alert('Belum ada data biaya untuk Job Order ini!');
                return;
            }

            // Generate Invoice Number
            const invoiceNo = 'INV-' + jobOrder.jobOrderNo;

            // Populate invoice preview
            document.getElementById('invInvoiceNo').textContent = invoiceNo;
            document.getElementById('invJobOrderNo').textContent = jobOrder.jobOrderNo;
            document.getElementById('invDate').textContent = new Date().toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('invCustomer').textContent = jobOrder.customerName;
            document.getElementById('invOrigin').textContent = jobOrder.origin || '-';
            document.getElementById('invDestination').textContent = jobOrder.destination || '-';
            document.getElementById('invShip').textContent = jobOrder.shipName || '-';
            document.getElementById('invETD').textContent = jobOrder.etd ? new Date(jobOrder.etd).toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '-';

            // Populate invoice table
            const invoiceTable = document.querySelector('#invoiceTable tbody');
            invoiceTable.innerHTML = '';

            let subtotal = 0;
            let totalPPN = 0;

            costData.items.forEach((cost, index) => {
                const itemSubtotal = cost.price * cost.quantity;
                const dpp = cost.ppn ? itemSubtotal * 11 / 12 : itemSubtotal;
                const ppn = cost.ppn ? itemSubtotal * 1 / 12 : 0;

                subtotal += itemSubtotal;
                totalPPN += ppn;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td style="text-align: center;">${index + 1}</td>
            <td>${cost.name}</td>
            <td style="text-align: center;">${cost.quantity} x ${formatCurrency(cost.price)}</td>
            <td style="text-align: right;">${formatCurrency(dpp)}</td>
            <td style="text-align: right;">${formatCurrency(ppn)}</td>
            <td style="text-align: right;"><strong>${formatCurrency(itemSubtotal)}</strong></td>
        `;
                invoiceTable.appendChild(row);
            });

            // Update totals
            document.getElementById('invSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invPPN').textContent = formatCurrency(totalPPN);
            document.getElementById('invTotal').textContent = formatCurrency(subtotal);

            // Update terbilang
            document.getElementById('invTerbilang').textContent = angkaTerbilang(subtotal);

            // Show invoice preview and scroll to it
            const invoicePreview = document.getElementById('invoicePreview');
            invoicePreview.style.display = 'block';
            invoicePreview.scrollIntoView({ behavior: 'smooth', block: 'start' });

            alert(`Invoice berhasil di-generate!\n\nNo. Invoice: ${invoiceNo}\nTotal: ${formatCurrency(subtotal)}\nTerbilang: ${angkaTerbilang(subtotal)}`);
        });

        // Print invoice
        document.getElementById('printInvoiceBtn').addEventListener('click', function () {
            window.print();
        });

        // Export All Data to Excel
        document.getElementById('exportExcelBtn').addEventListener('click', function () {
            if (allJobOrders.length === 0) {
                alert('Tidak ada data untuk di-export!');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();

            // ===== SHEET 1: JOB ORDERS =====
            const jobOrderData = [
                ['LAPORAN DATA JOB ORDER'],
                ['PT. PASIR INDAH LOGISTIK'],
                ['Tanggal Export: ' + new Date().toLocaleDateString('id-ID')],
                [], // Empty row
                ['No.', 'No. Job Order', 'Tanggal', 'Konsumen', 'Party', 'Asal', 'Tujuan', 'Kapal', 'ETD', 'Keterangan']
            ];

            allJobOrders.forEach((jo, index) => {
                const partyText = jo.party.map(p => `${p.size}(${p.quantity})`).join(', ');
                const dateText = new Date(jo.createdDate).toLocaleDateString('id-ID');
                const etdText = jo.etd ? new Date(jo.etd).toLocaleDateString('id-ID') : '-';

                jobOrderData.push([
                    index + 1,
                    jo.jobOrderNo,
                    dateText,
                    jo.customerName,
                    partyText,
                    jo.origin || '-',
                    jo.destination || '-',
                    jo.shipName || '-',
                    etdText,
                    jo.notes || '-'
                ]);
            });

            const ws1 = XLSX.utils.aoa_to_sheet(jobOrderData);

            // Set column widths
            ws1['!cols'] = [
                { wch: 5 }, { wch: 15 }, { wch: 12 }, { wch: 20 }, { wch: 20 },
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 25 }
            ];

            XLSX.utils.book_append_sheet(wb, ws1, 'Job Orders');

            // ===== SHEET 2: STAFFING =====
            const staffingData = [
                ['LAPORAN DATA STAFFING'],
                ['PT. PASIR INDAH LOGISTIK'],
                ['Tanggal Export: ' + new Date().toLocaleDateString('id-ID')],
                [],
                ['No.', 'No. Job Order', 'Konsumen', 'Tanggal Staffing', 'Party', 'No. Container']
            ];

            let staffingNo = 1;
            allStaffingData.forEach(sd => {
                const jo = allJobOrders.find(j => j.id === sd.jobOrderId);
                if (!jo) return;

                const dateText = new Date(sd.date).toLocaleDateString('id-ID');

                // Group containers by party
                const groupedContainers = {};
                sd.containers.forEach(c => {
                    if (!groupedContainers[c.party]) {
                        groupedContainers[c.party] = [];
                    }
                    groupedContainers[c.party].push(c.number);
                });

                // Add rows for each container
                Object.keys(groupedContainers).forEach(party => {
                    groupedContainers[party].forEach((containerNo, idx) => {
                        staffingData.push([
                            staffingNo,
                            jo.jobOrderNo,
                            jo.customerName,
                            dateText,
                            party,
                            containerNo
                        ]);
                        staffingNo++;
                    });
                });
            });

            const ws2 = XLSX.utils.aoa_to_sheet(staffingData);
            ws2['!cols'] = [
                { wch: 5 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 25 }
            ];
            XLSX.utils.book_append_sheet(wb, ws2, 'Staffing');

            // ===== SHEET 3: BIAYA =====
            const costData = [
                ['LAPORAN DATA BIAYA'],
                ['PT. PASIR INDAH LOGISTIK'],
                ['Tanggal Export: ' + new Date().toLocaleDateString('id-ID')],
                [],
                ['No.', 'No. Job Order', 'Konsumen', 'Item', 'Harga', 'Qty', 'PPN', 'DPP', 'PPN Amount', 'Total']
            ];

            let costNo = 1;
            allCostData.forEach(cd => {
                const jo = allJobOrders.find(j => j.id === cd.jobOrderId);
                if (!jo) return;

                cd.items.forEach(item => {
                    const itemSubtotal = item.price * item.quantity;
                    const dpp = item.ppn ? itemSubtotal * 11 / 12 : itemSubtotal;
                    const ppn = item.ppn ? itemSubtotal * 1 / 12 : 0;

                    costData.push([
                        costNo,
                        jo.jobOrderNo,
                        jo.customerName,
                        item.name,
                        item.price,
                        item.quantity,
                        item.ppn ? 'Ya' : 'Tidak',
                        dpp,
                        ppn,
                        itemSubtotal
                    ]);
                    costNo++;
                });
            });

            // Add total summary
            costData.push([]);
            costData.push(['', '', '', '', '', '', '', '', 'GRAND TOTAL:',
                allCostData.reduce((sum, cd) => {
                    return sum + cd.items.reduce((itemSum, item) => {
                        return itemSum + (item.price * item.quantity);
                    }, 0);
                }, 0)
            ]);

            const ws3 = XLSX.utils.aoa_to_sheet(costData);
            ws3['!cols'] = [
                { wch: 5 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 12 },
                { wch: 5 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
            ];
            XLSX.utils.book_append_sheet(wb, ws3, 'Biaya');

            // ===== SHEET 4: SUMMARY =====
            const summaryData = [
                ['RINGKASAN LAPORAN'],
                ['PT. PASIR INDAH LOGISTIK'],
                ['Tanggal Export: ' + new Date().toLocaleDateString('id-ID')],
                [],
                ['Kategori', 'Jumlah'],
                ['Total Job Orders', allJobOrders.length],
                ['Total Data Staffing', allStaffingData.length],
                ['Total Container', allStaffingData.reduce((sum, sd) => sum + sd.containers.length, 0)],
                ['Total Data Biaya', allCostData.length],
                [],
                ['RINCIAN PER KONSUMEN'],
                ['Konsumen', 'Job Orders', 'Total Biaya'],
            ];

            // Get unique customers and their totals
            const customerStats = {};
            allJobOrders.forEach(jo => {
                if (!customerStats[jo.customerName]) {
                    customerStats[jo.customerName] = {
                        jobOrders: 0,
                        totalCost: 0
                    };
                }
                customerStats[jo.customerName].jobOrders++;

                const costForJO = allCostData.find(cd => cd.jobOrderId === jo.id);
                if (costForJO) {
                    customerStats[jo.customerName].totalCost += costForJO.items.reduce((sum, item) => {
                        return sum + (item.price * item.quantity);
                    }, 0);
                }
            });

            Object.keys(customerStats).forEach(customer => {
                summaryData.push([
                    customer,
                    customerStats[customer].jobOrders,
                    customerStats[customer].totalCost
                ]);
            });

            const ws4 = XLSX.utils.aoa_to_sheet(summaryData);
            ws4['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws4, 'Summary');

            // Generate Excel file
            const fileName = `Laporan_EMKL_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            alert(`Laporan berhasil di-export!\n\n` +
                `File: ${fileName}\n` +
                `Total Job Orders: ${allJobOrders.length}\n` +
                `Total Staffing: ${allStaffingData.length}\n` +
                `Total Biaya: ${allCostData.length}`);
        });

        // Format currency helper
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // ========== BACKUP & RESTORE FUNCTIONALITY ==========

        // Backup Data
        document.getElementById('backupDataBtn').addEventListener('click', function () {
            try {
                // Kumpulkan semua data
                const backupData = {
                    version: '1.0',
                    backupDate: new Date().toISOString(),
                    data: {
                        allJobOrders: allJobOrders,
                        allStaffingData: allStaffingData,
                        allCostData: allCostData,
                        customers: JSON.parse(localStorage.getItem('customers')) || []
                    },
                    stats: {
                        totalJobOrders: allJobOrders.length,
                        totalStaffing: allStaffingData.length,
                        totalCost: allCostData.length,
                        totalCustomers: (JSON.parse(localStorage.getItem('customers')) || []).length
                    }
                };

                // Convert to JSON
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });

                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `EMKL_Backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Update info
                document.getElementById('backupInfo').innerHTML =
                    `✅ Backup berhasil!<br>` +
                    `Job Orders: ${backupData.stats.totalJobOrders} | ` +
                    `Staffing: ${backupData.stats.totalStaffing} | ` +
                    `Biaya: ${backupData.stats.totalCost}`;

                alert(`Backup berhasil dibuat!\n\n` +
                    `Total Job Orders: ${backupData.stats.totalJobOrders}\n` +
                    `Total Staffing: ${backupData.stats.totalStaffing}\n` +
                    `Total Biaya: ${backupData.stats.totalCost}\n` +
                    `Total Konsumen: ${backupData.stats.totalCustomers}\n\n` +
                    `File telah didownload.`);

            } catch (error) {
                console.error('Backup error:', error);
                alert('Gagal membuat backup: ' + error.message);
            }
        });

        // Restore Data - Merge without duplicates
        document.getElementById('restoreDataBtn').addEventListener('click', function () {
            const fileInput = document.getElementById('restoreFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Pilih file backup terlebih dahulu!');
                return;
            }

            if (!file.name.endsWith('.json')) {
                alert('File harus berformat JSON!');
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // Validasi struktur data
                    if (!backupData.data || !backupData.version) {
                        throw new Error('Format file backup tidak valid!');
                    }

                    // Statistik untuk report
                    let stats = {
                        jobOrders: { existing: allJobOrders.length, imported: 0, skipped: 0 },
                        staffing: { existing: allStaffingData.length, imported: 0, skipped: 0 },
                        cost: { existing: allCostData.length, imported: 0, skipped: 0 },
                        customers: { existing: 0, imported: 0, skipped: 0 }
                    };

                    // ===== MERGE JOB ORDERS =====
                    const existingJobOrderNos = new Set(allJobOrders.map(jo => jo.jobOrderNo));
                    const backupJobOrders = backupData.data.allJobOrders || [];

                    backupJobOrders.forEach(jo => {
                        if (!existingJobOrderNos.has(jo.jobOrderNo)) {
                            // Generate new ID untuk menghindari konflik
                            jo.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                            allJobOrders.push(jo);
                            stats.jobOrders.imported++;
                        } else {
                            stats.jobOrders.skipped++;
                        }
                    });

                    // ===== MERGE STAFFING DATA =====
                    // Buat unique key dari jobOrderNo + date + containers
                    const existingStaffingKeys = new Set(allStaffingData.map(sd => {
                        const jo = allJobOrders.find(j => j.id === sd.jobOrderId);
                        const containerNos = sd.containers.map(c => c.number).sort().join('|');
                        return jo ? `${jo.jobOrderNo}_${sd.date}_${containerNos}` : null;
                    }).filter(Boolean));

                    const backupStaffing = backupData.data.allStaffingData || [];

                    backupStaffing.forEach(sd => {
                        // Cari job order yang sesuai berdasarkan jobOrderNo
                        const matchingJO = allJobOrders.find(jo => jo.jobOrderNo === sd.jobOrderNo);

                        if (matchingJO) {
                            const containerNos = sd.containers.map(c => c.number).sort().join('|');
                            const uniqueKey = `${sd.jobOrderNo}_${sd.date}_${containerNos}`;

                            if (!existingStaffingKeys.has(uniqueKey)) {
                                // Update jobOrderId ke ID yang ada di sistem
                                sd.jobOrderId = matchingJO.id;
                                sd.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                allStaffingData.push(sd);
                                stats.staffing.imported++;
                            } else {
                                stats.staffing.skipped++;
                            }
                        } else {
                            // Job Order tidak ditemukan, skip
                            stats.staffing.skipped++;
                        }
                    });

                    // ===== MERGE COST DATA =====
                    // Buat unique key dari jobOrderNo + items
                    const existingCostKeys = new Set(allCostData.map(cd => {
                        const jo = allJobOrders.find(j => j.id === cd.jobOrderId);
                        const itemsKey = cd.items.map(i => `${i.name}_${i.price}_${i.quantity}`).sort().join('|');
                        return jo ? `${jo.jobOrderNo}_${itemsKey}` : null;
                    }).filter(Boolean));

                    const backupCost = backupData.data.allCostData || [];

                    backupCost.forEach(cd => {
                        // Cari job order yang sesuai
                        const matchingJO = allJobOrders.find(jo => jo.jobOrderNo === cd.jobOrderNo);

                        if (matchingJO) {
                            const itemsKey = cd.items.map(i => `${i.name}_${i.price}_${i.quantity}`).sort().join('|');
                            const uniqueKey = `${cd.jobOrderNo}_${itemsKey}`;

                            if (!existingCostKeys.has(uniqueKey)) {
                                cd.jobOrderId = matchingJO.id;
                                cd.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                allCostData.push(cd);
                                stats.cost.imported++;
                            } else {
                                stats.cost.skipped++;
                            }
                        } else {
                            stats.cost.skipped++;
                        }
                    });

                    // ===== MERGE CUSTOMERS =====
                    const existingCustomers = JSON.parse(localStorage.getItem('customers')) || [];
                    const backupCustomers = backupData.data.customers || [];

                    stats.customers.existing = existingCustomers.length;

                    backupCustomers.forEach(customer => {
                        if (!existingCustomers.includes(customer)) {
                            existingCustomers.push(customer);
                            stats.customers.imported++;
                        } else {
                            stats.customers.skipped++;
                        }
                    });

                    // ===== SAVE TO LOCALSTORAGE =====
                    localStorage.setItem('allJobOrders', JSON.stringify(allJobOrders));
                    localStorage.setItem('allStaffingData', JSON.stringify(allStaffingData));
                    localStorage.setItem('allCostData', JSON.stringify(allCostData));
                    localStorage.setItem('customers', JSON.stringify(existingCustomers));

                    // ===== REFRESH UI =====
                    loadJobOrdersList();
                    initializeData();
                    renderJobOrderHistory();
                    renderStaffingHistory();
                    renderCostHistory();

                    // ===== SHOW REPORT =====
                    const report =
                        `✅ RESTORE BERHASIL!\n\n` +
                        `📋 JOB ORDERS:\n` +
                        `   • Data Sebelumnya: ${stats.jobOrders.existing}\n` +
                        `   • Berhasil Ditambahkan: ${stats.jobOrders.imported}\n` +
                        `   • Duplikat (Dilewati): ${stats.jobOrders.skipped}\n` +
                        `   • Total Sekarang: ${allJobOrders.length}\n\n` +
                        `👥 STAFFING:\n` +
                        `   • Data Sebelumnya: ${stats.staffing.existing}\n` +
                        `   • Berhasil Ditambahkan: ${stats.staffing.imported}\n` +
                        `   • Duplikat (Dilewati): ${stats.staffing.skipped}\n` +
                        `   • Total Sekarang: ${allStaffingData.length}\n\n` +
                        `💰 BIAYA:\n` +
                        `   • Data Sebelumnya: ${stats.cost.existing}\n` +
                        `   • Berhasil Ditambahkan: ${stats.cost.imported}\n` +
                        `   • Duplikat (Dilewati): ${stats.cost.skipped}\n` +
                        `   • Total Sekarang: ${allCostData.length}\n\n` +
                        `🏢 KONSUMEN:\n` +
                        `   • Data Sebelumnya: ${stats.customers.existing}\n` +
                        `   • Berhasil Ditambahkan: ${stats.customers.imported}\n` +
                        `   • Duplikat (Dilewati): ${stats.customers.skipped}\n` +
                        `   • Total Sekarang: ${existingCustomers.length}\n\n` +
                        `Tanggal Backup: ${new Date(backupData.backupDate).toLocaleString('id-ID')}\n\n` +
                        `Halaman akan di-refresh...`;

                    alert(report);

                    // Reset file input
                    fileInput.value = '';

                    // Refresh halaman
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } catch (error) {
                    console.error('Restore error:', error);
                    alert('Gagal restore data: ' + error.message + '\n\nPastikan file backup valid.');
                }
            };

            reader.onerror = function () {
                alert('Gagal membaca file!');
            };

            reader.readAsText(file);
        });
        // Clear All Data
        document.getElementById('clearAllDataBtn').addEventListener('click', function () {
            if (!confirm('⚠️ PERINGATAN KERAS!\n\n' +
                'Anda akan MENGHAPUS SEMUA DATA secara PERMANEN!\n' +
                'Data yang dihapus TIDAK BISA dikembalikan!\n\n' +
                'Pastikan Anda sudah backup data terlebih dahulu.\n\n' +
                'Ketik "HAPUS SEMUA" untuk konfirmasi:')) {
                return;
            }

            const confirmation = prompt('Ketik "HAPUS SEMUA" (tanpa tanda petik) untuk melanjutkan:');

            if (confirmation !== 'HAPUS SEMUA') {
                alert('Konfirmasi tidak sesuai. Penghapusan dibatalkan.');
                return;
            }

            try {
                // Clear localStorage
                localStorage.removeItem('allJobOrders');
                localStorage.removeItem('allStaffingData');
                localStorage.removeItem('allCostData');
                localStorage.removeItem('customers');

                // Clear variables
                allJobOrders = [];
                allStaffingData = [];
                allCostData = [];

                alert('✅ Semua data berhasil dihapus!\n\nHalaman akan di-refresh...');

                // Reload page
                setTimeout(() => {
                    location.reload();
                }, 1000);

            } catch (error) {
                console.error('Clear data error:', error);
                alert('Gagal menghapus data: ' + error.message);
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Load all job orders
            allJobOrders = JSON.parse(localStorage.getItem('allJobOrders')) || [];
            allStaffingData = JSON.parse(localStorage.getItem('allStaffingData')) || [];
            allCostData = JSON.parse(localStorage.getItem('allCostData')) || [];

            // Set job order number untuk form baru
            document.getElementById('jobOrderNo').value = generateJobOrderNo();

            // Load job orders list to all selects
            loadJobOrdersList();

            // Initialize form
            initializeData();

            // Add initial cost item
            addCostItem();
        });
    </script>
</body>

</html>
